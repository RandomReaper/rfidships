<!DOCTYPE HTML>

<html>
   <head>
     <link rel="stylesheet" href="style.css">
<script type = "text/javascript">
const STATE_STARTED = 0
const STATE_STOPPED = 1
const STATE_DNS     = 2

const toto = new Map([
["E28011606000021477F6DC21",3],
["E28011606000021533A3F527",4],
["E28011606000021477F6DC22",5],
["E28011606000021533A3F526",6],
["E28011606000021477F6DC23",7],
["E28011606000021533A3F525",8],
["E28011606000021477F6DC24",9],
["E28011606000021533A3F524",10],
["E28011606000021477F6DC25",11],
["E28011606000021533A3F523",12],
["E28011606000021477F6DC26",13],
["E28011606000021533A3F522",14],
["E28011606000021477F6DC27",15],
["E28011606000021533A3F521",16],
["E28011606000021477F6DC28",17],
["E28011606000021533A3F520",18],
["E28011606000021477F6DC29",19],
["E28011606000021533A3E42F",20],
["E28011606000021477F6DC2A",21],
["E28011606000021533A3E42E",22],
["E28011606000021477F6DC2B",23],
["E28011606000021533A3E42D",24],
["E28011606000021477F6DC2D",25],
["E28011606000021533A3E42C",26],
["E28011606000021477F6DC2E",27],
["E28011606000021533A3E42B",28],
["E28011606000021477F6DC2F",29],
["E28011606000021533A3E42A",30],
["E28011606000021477F6DC1F",31],
["E28011606000021533A3E429",32],
["E28011606000021477F6DC1E",33],
["E28011606000021533A3E428",34],
["E28011606000021477F6DC1D",35],
["E28011606000021533A3E427",36],
["E28011606000021477F6DC1C",37],
["E28011606000021533A3E426",38],
["E28011606000021477F6DC1B",39],
["E28011606000021533A3E425",40],
["E28011606000021477F6DC1A",41],
["E28011606000021533A3E424",42],
["E28011606000021477F6DC19",43],
["E28011606000021533A3E423",44],
["E28011606000021477F6DC18",45],
["E28011606000021533A3E422",46],
["E28011606000021477F6DC17",47],
["E28011606000021533A3E421",48],
["E28011606000021477F6DC16",49],
["E28011606000021533A3E420",50],
["E28011606000021477F6DC15",51],
["E28011606000021533A3ED2F",52],
["E28011606000021477F6DC14",53],
["E28011606000021533A3ED2E",54],
["E28011606000021477F6DC13",55],
["E28011606000021533A3ED2D",56],
["E28011606000021477F6DC12",57],
["E28011606000021533A3ED2C",58],
["E28011606000021477F6DC11",59],
["E28011606000021533A3ED2B",60],
["E28011606000021477F6DC10",61],
["E28011606000021533A3ED2A",62],
["E28011606000021477F6ED1F",63],
["E28011606000021533A3ED29",64],
["E28011606000021477F6ED1E",65],
["E28011606000021533A3ED28",66],
["E28011606000021477F6ED1D",67],
["E28011606000021533A3ED27",68],
["E28011606000021477F6ED1C",69],
["E28011606000021533A3ED26",70],
["E28011606000021477F6ED1B",71],
["E28011606000021533A3ED25",72],
["E28011606000021477F6ED1A",73],
["E28011606000021533A3ED24",74],
["E28011606000021477F6ED19",75],
["E28011606000021533A3ED23",76],
["E28011606000021477F6ED18",77],
["E28011606000021533A3ED22",78],
["E28011606000021477F6ED17",79],
["E28011606000021533A3ED21",80],
["E28011606000021477F6ED16",81],
["E28011606000021533A3ED20",82],
["E28011606000021477F6ED15",83],
["E28011606000021533A3DC2F",84],
["E28011606000021477F6ED14",85],
["E28011606000021533A3DC2E",86],
["E28011606000021477F6ED13",87],
["E28011606000021533A3DC2D",88],
["E28011606000021477F6ED12",89],
["E28011606000021533A3DC2C",90],
["E28011606000021477F6ED11",91],
["E28011606000021533A3DC2B",92],
["E28011606000021477F6ED10",93],
["E28011606000021533A3DC2A",94],
["E28011606000021477F6D41F",95],
["E28011606000021533A3DC29",96],
["E28011606000021477F6D41E",97],
["E28011606000021533A3DC28",98],
["E28011606000021477F6D41D",99],
["E28011606000021533A3DC27",100],
])

function hex2a(hexx) {
  var hex = hexx.toString();
  var str = '';
  for (var i = 0; i < hex.length; i += 2)
      str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
  return str;
}
function name(tag) {
  var h = hex2a(tag)
  if (tag.toString().startsWith("E280")) {


    return toto.get(tag.toString()).toString();
  }
  if (h.startsWith("hessopalp")) {
    return h.substring(9).replaceAll("0", "&nbsp;")
  }

  return h;
}
function padTo2Digits(num) {
  return num.toString().padStart(2, '0');
}

function padTo3Digits(num) {
  return num.toString().padStart(3, '0');
}

function convertMsToTime(milliseconds) {
  let ms = milliseconds % 1000;
  let cs = Math.floor(milliseconds/10) % 100;
  let seconds = Math.floor(milliseconds / 1000);
  let minutes = Math.floor(seconds / 60);

  seconds = seconds % 60;
  minutes = minutes % 60;

  return `${padTo2Digits(minutes)}:${padTo2Digits(seconds)}.${padTo2Digits(cs)}`;
}
let list = new Map();

function stop(key) {
  list.get(key).stop=Date.now();
}

function Start() {

  if ("WebSocket" in window) {
     var ws = new WebSocket("ws://localhost:1234/");

     ws.onopen = function() {
       document.getElementById('c1').innerHTML='';
     };

     ws.onmessage = function (evt) {
        let r = JSON.parse(evt.data);
        let now = Date.now()
        let o = {
          nr : r.tag,
          name : name(r.tag),
          state : STATE_STARTED,
          start : now,
          stop : now
        }
        list.set(r.tag, o)
     };

     ws.onclose = function() {
       document.getElementById('c1').innerHTML='ws1 not connected'
       console.log("Connection is closed (departure)...");
     };
  }

  if ("WebSocket" in window) {
     var ws = new WebSocket("ws://localhost:1235/");

     ws.onopen = function() {
       document.getElementById('c2').innerHTML='';
     };

     ws.onmessage = function (evt) {

        let r = JSON.parse(evt.data);
        let now = Date.now()
        if (list.has(r.tag)) {
          if (list.get(r.tag).state == STATE_STARTED) {
            list.get(r.tag).state = STATE_STOPPED
            list.get(r.tag).stop = now
          }
        }
        else {
            let o = {
              nr : r.tag,
              name : name(r.tag),
              state : STATE_DNS,
              start : now,
              stop : now
            }
            list.set(r.tag, o)
        }
     };

     ws.onclose = function() {
        document.getElementById('c2').innerHTML='ws2 not connected'
        console.log("Connection is closed (arrival)...");
     };
  }

  setInterval(function() {

    let a = "<table><tr><th>Bateau</th><th>Temps</th></tr>"
    let now = Date.now()
    let list1 = new Map();
    for (const [key, value] of list.entries()) {
      let o = {time : value.stop > value.start ? value.stop-value.start : now-value.start, name:value.name}
      list1.set(key, o)
    }
    //list1 = new Map([...list1.entries()].sort((a, b) => a[1].time - b[1].time));
    for (const [k, v] of list1.entries()) {
        switch (list.get(k).state) {
            case STATE_STARTED:
                a+="<tr class=\"running\">"
                a+="<td>"+v.name+"</td>"
                a+="<td><div>"+convertMsToTime(v.time)+"<div></td>"
                a+="</tr>"
            break;
            case STATE_STOPPED:
                a+="<tr class=\"stopped\">"
                a+="<td>"+v.name+"</td>"
                a+="<td><div>"+convertMsToTime(v.time)+"<div></td>"
                a+="</tr>"
            break;
            case STATE_DNS:
            default:
                a+="<tr class=\"dns\">"
                a+="<td>"+v.name+"</td>"
                a+="<td>identifi√©</td>"
                a+="</tr>"
            break;
        }
      }

    a += "</table>"
    document.getElementById('log').innerHTML = a

    // remove
    list = new Map([...list].filter(([k,v]) =>
      (v.state == STATE_STARTED && now < v.stop + 2*60*1000)
      || (v.state == STATE_STOPPED && now < v.stop + 2*60*1000)
      || (v.state == STATE_DNS && now < v.stop + 10*1000)
    ))
  }, 50);
}
</script>
</head>
<body onload="Start()">
  <img src="img/EN_HEI_neg.png" width="30%">
  <div id=c1>ws1 not connected</div>
  <div id=c2>ws2 not connected</div>
  <div id="log">initial content</div>
</body>
</html>
